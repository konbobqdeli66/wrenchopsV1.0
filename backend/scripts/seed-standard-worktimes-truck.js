/* eslint-disable no-console */
// Seed a "starter batch" (~200) standardized truck worktimes (BG) mapped to our 11–99 subcategory codes.
//
// Notes:
// - Times are ориентировъчни (non-OEM) and are meant to be adjusted per workshop.
// - component_type is the SUBCATEGORY key as a 2-digit string (e.g. "22"), so it fits our UI classification.
// - vehicle_type is stored in DB as 'truck'.
//
// Run:
//   npm --prefix backend run seed-standard-worktimes:truck

const path = require('path');
const sqlite3 = require('sqlite3').verbose();

const DB_PATH = path.join(__dirname, '..', 'truck.db');

const run = (db, sql, params = []) =>
  new Promise((resolve, reject) => {
    db.run(sql, params, function (err) {
      if (err) return reject(err);
      return resolve(this);
    });
  });

const get = (db, sql, params = []) =>
  new Promise((resolve, reject) => {
    db.get(sql, params, (err, row) => {
      if (err) return reject(err);
      return resolve(row || null);
    });
  });

const safeHours = (h) => {
  const n = Number(h);
  if (!Number.isFinite(n) || n < 0) return 0;
  // Clamp extreme values (avoid accidental 200h)
  return Math.min(40, Math.round(n * 10) / 10);
};

// Helper to create items quickly
const wt = (title, hours, subKey) => ({
  title: String(title).trim(),
  hours: safeHours(hours),
  component_type: String(subKey).padStart(2, '0'),
  vehicle_type: 'truck',
});

// IMPORTANT: Keep titles unique-ish; we dedupe by (title + component_type + vehicle_type).
// This is a practical standardized set (truck-only) to start with; extend in next batches.
const SEED = [
  // 17: Service & maintenance
  wt('Първоначален оглед / приемане на автомобила', 0.5, 17),
  wt('Диагностика със скенер (прочит грешки)', 0.8, 17),
  wt('Диагностика със скенер + тест на път', 1.5, 17),
  wt('Проверка течове (масло/антифриз/гориво)', 0.6, 17),
  wt('Проверка на спирачна система (визуално)', 0.6, 17),
  wt('Проверка осветление и сигнализация', 0.4, 17),
  wt('Проверка акумулатор/зареждане', 0.5, 17),
  wt('Проверка ремъци и ролки (визуално)', 0.4, 17),
  wt('Смяна чистачки (комплект)', 0.3, 17),
  wt('Смяна крушка (достъпна)', 0.2, 17),
  wt('Смяна предпазител', 0.2, 17),
  wt('Смяна реле', 0.3, 17),
  wt('Сервизиране/смазване на ключалки и панти', 0.4, 17),
  wt('Реглаж/проверка на фарове', 0.5, 17),

  // 22: Lubricating and oil system
  wt('Смяна моторно масло + маслен филтър', 1.2, 22),
  wt('Смяна моторно масло + филтър (с промивка)', 1.6, 22),
  wt('Смяна масло (междинен сервиз)', 0.9, 22),
  wt('Смяна картерна пробка/уплътнение', 0.4, 22),
  wt('Смяна гарнитура картер', 2.8, 22),
  wt('Смяна маслоохладител', 3.0, 22),
  wt('Смяна уплътнения маслоохладител', 2.0, 22),
  wt('Смяна датчик налягане масло', 0.6, 22),
  wt('Смяна клапан/вентилация картерни газове', 1.0, 22),
  wt('Почистване/смяна сепаратор картерни газове', 1.5, 22),
  wt('Ремонт/смяна маслена помпа', 6.0, 22),
  wt('Проверка налягане масло (механичен манометър)', 1.0, 22),
  wt('Отстраняване теч от капак клапани (уплътнение)', 2.5, 22),
  wt('Смяна гарнитура капак клапани', 2.0, 22),

  // 23: Fuel system
  wt('Смяна горивен филтър', 0.7, 23),
  wt('Смяна горивен филтър (двойка/2 бр.)', 1.0, 23),
  wt('Обезвъздушаване горивна система', 0.6, 23),
  wt('Проверка налягане гориво', 1.0, 23),
  wt('Почистване резервоар (външен достъп)', 3.5, 23),
  wt('Смяна горивна помпа (подкачваща)', 2.2, 23),
  wt('Смяна горивна рейка/тръби (локално)', 2.5, 23),
  wt('Смяна горивни маркучи (комплект)', 1.5, 23),
  wt('Смяна дюза (една)', 2.5, 23),
  wt('Смяна комплект дюзи', 8.0, 23),
  wt('Тест на дюзи (демонтаж/монтаж + проверка)', 5.0, 23),
  wt('Смяна клапан дозиране гориво', 1.8, 23),

  // 25: Intake and exhaust systems. Turbo
  wt('Смяна въздушен филтър', 0.4, 25),
  wt('Смяна филтър картерни газове', 0.6, 25),
  wt('Смяна маркуч интеркулер', 0.8, 25),
  wt('Смяна интеркулер', 2.8, 25),
  wt('Почистване EGR клапан', 2.0, 25),
  wt('Смяна EGR клапан', 2.5, 25),
  wt('Почистване EGR охладител', 4.0, 25),
  wt('Смяна EGR охладител', 4.5, 25),
  wt('Смяна турбокомпресор', 5.5, 25),
  wt('Проверка/ремонт актуатор турбо', 2.0, 25),
  wt('Смяна датчик налягане турбо (MAP)', 0.6, 25),
  wt('Смяна датчик дебит въздух (MAF)', 0.6, 25),
  wt('Смяна ауспух/участък от изпускателна система', 2.5, 25),
  wt('Смяна гъвкава връзка (гофре)', 2.0, 25),

  // 26: Cooling system
  wt('Смяна антифриз (пълна)', 1.4, 26),
  wt('Промивка охладителна система', 2.0, 26),
  wt('Смяна термостат', 1.8, 26),
  wt('Смяна водна помпа', 4.5, 26),
  wt('Смяна радиатор', 3.5, 26),
  wt('Смяна капачка разширителен съд', 0.2, 26),
  wt('Смяна разширителен съд', 0.8, 26),
  wt('Смяна маркуч охладителна система (един)', 0.9, 26),
  wt('Смяна комплект маркучи охладителна система', 2.5, 26),
  wt('Проверка за CO2 в охладителна система', 1.0, 26),
  wt('Смяна вентилатор/вискомуфа', 2.5, 26),
  wt('Смяна датчик температура', 0.7, 26),
  wt('Смяна радиатор парно', 6.0, 26),

  // 27: engine / motor controls
  wt('Диагностика управление на двигателя (ECU)', 1.2, 27),
  wt('Проверка/ремонт инсталация двигател (локално)', 2.0, 27),
  wt('Смяна датчик колянов вал', 1.2, 27),
  wt('Смяна датчик разпределителен вал', 1.0, 27),
  wt('Смяна педал газ (потенциометър)', 0.8, 27),
  wt('Смяна дросел/клапа (ако има)', 1.5, 27),
  wt('Смяна ECU (демонтаж/монтаж)', 1.5, 27),
  wt('Програмиране/кодиране ECU (ориентировъчно)', 1.5, 27),
  wt('Смяна сензор NOx', 1.0, 27),
  wt('Смяна датчик диференциално налягане DPF', 0.8, 27),
  wt('Регенерация DPF (принудителна)', 1.5, 27),

  // 28: Ignition and control systems (diesel control / general)
  wt('Проверка/смяна свещ подгрев (1 бр.)', 1.0, 28),
  wt('Смяна комплект свещи подгрев', 3.0, 28),
  wt('Смяна реле подгрев', 0.6, 28),
  wt('Смяна модул управление (общ)', 1.2, 28),

  // 31: Battery; energy storage system; mounting parts
  wt('Смяна акумулатор (1 бр.)', 0.6, 31),
  wt('Смяна комплект акумулатори (2 бр.)', 1.0, 31),
  wt('Тест акумулатор (товарна вилка)', 0.4, 31),
  wt('Почистване клеми/обработка срещу окисляване', 0.4, 31),
  wt('Смяна клеми акумулатор', 0.4, 31),
  wt('Смяна кабел маса', 0.7, 31),
  wt('Смяна стойка/кутия акумулатори', 1.2, 31),

  // 32: Alternator; charging; electric motor; drives
  wt('Диагностика зарядна система', 0.8, 32),
  wt('Смяна алтернатор', 2.0, 32),
  wt('Ремонт алтернатор (дем/монтаж)', 2.5, 32),
  wt('Смяна ремък алтернатор', 1.0, 32),
  wt('Смяна обтегач ремък', 1.5, 32),
  wt('Смяна ролка ремък', 0.8, 32),

  // 33: Starting system
  wt('Диагностика стартерна система', 0.8, 33),
  wt('Смяна стартер', 2.5, 33),
  wt('Ремонт стартер (дем/монтаж)', 3.0, 33),
  wt('Смяна реле стартер', 0.5, 33),
  wt('Смяна контактна група/ключ (ако има)', 1.2, 33),

  // 35: Lighting
  wt('Смяна крушка фар (H7/H4) - труд', 0.3, 35),
  wt('Смяна крушка габарит/позиция - труд', 0.2, 35),
  wt('Смяна крушка мигач - труд', 0.2, 35),
  wt('Смяна задна стоп/габарит лампа - труд', 0.3, 35),
  wt('Смяна фар (ляв/десен) - труд', 1.2, 35),
  wt('Полиране фарове (комплект) - труд', 1.5, 35),
  wt('Монтаж допълнителни LED барове (ориент.)', 2.5, 35),

  // 37: Cables and fuses
  wt('Диагностика късо съединение (ел. инсталация)', 2.0, 37),
  wt('Ремонт кабелен сноп (локално)', 2.5, 37),
  wt('Смяна предпазителен блок', 1.5, 37),
  wt('Смяна конектор/букса (една)', 0.8, 37),
  wt('Смяна кабел/проводник (до 2м)', 1.2, 37),

  // 38: Instruments
  wt('Диагностика табло/индикатори', 1.0, 38),
  wt('Смяна датчик скорост', 1.0, 38),
  wt('Смяна датчик ABS (един)', 1.0, 38),
  wt('Смяна датчик налягане въздух (табло)', 0.8, 38),
  wt('Смяна датчик температура (табло)', 0.8, 38),
  wt('Смяна/калибрация тахограф (ориент.)', 2.0, 38),

  // 41: Clutch
  wt('Диагностика съединител', 1.0, 41),
  wt('Смяна съединител (комплект)', 7.5, 41),
  wt('Смяна лагер помпа съединител', 6.5, 41),
  wt('Смяна горна помпа съединител', 1.2, 41),
  wt('Смяна долна помпа съединител', 1.5, 41),
  wt('Обезвъздушаване съединител', 0.8, 41),

  // 43: Gearbox
  wt('Смяна масло скоростна кутия', 1.5, 43),
  wt('Диагностика скоростна кутия (електро/мех.)', 1.5, 43),
  wt('Смяна датчик/сензор скоростна кутия', 1.0, 43),
  wt('Смяна семеринг входящ вал', 6.0, 43),
  wt('Смяна семеринг изходящ вал', 5.5, 43),

  // 45: Propeller shaft
  wt('Смяна каре кардан (1 бр.)', 2.0, 45),
  wt('Смяна висящ лагер кардан', 2.5, 45),
  wt('Баланс кардан (дем/монтаж)', 3.5, 45),

  // 46: Axles / drive shaft
  wt('Смяна лагер главина (една)', 3.5, 46),
  wt('Смяна комплект лагери главина (една)', 4.0, 46),
  wt('Смяна семеринг главина', 2.5, 46),
  wt('Смяна полуоска', 3.0, 46),
  wt('Смяна масло диференциал', 1.5, 46),
  wt('Диагностика шум мост/диференциал', 1.5, 46),

  // 47: Final drive (combined)
  wt('Смяна масло в главно предаване', 1.8, 47),
  wt('Смяна семеринг пиньон', 4.5, 47),
  wt('Реглаж луфт главно предаване (ориент.)', 6.0, 47),

  // 50: Brakes - general
  wt('Диагностика спирачна система', 1.0, 50),
  wt('Смяна спирачна течност (ако е хидравлична)', 1.2, 50),
  wt('Проверка на спирачни барабани/дискове', 0.8, 50),

  // 51: Wheel brakes
  wt('Смяна накладки (една ос)', 3.0, 51),
  wt('Смяна дискове (една ос)', 3.5, 51),
  wt('Смяна барабани (една ос)', 4.0, 51),
  wt('Смяна спирачен апарат (един)', 2.0, 51),
  wt('Ремонт/рециклиране апарат (дем/монтаж)', 2.5, 51),
  wt('Реглаж автоматични регулатори (ос)', 1.0, 51),

  // 52: Hydraulic/vacuum-hydraulic brake system
  wt('Смяна спирачна помпа', 2.5, 52),
  wt('Смяна вакуум помпа', 2.5, 52),
  wt('Смяна серво усилвател', 3.0, 52),
  wt('Обезвъздушаване спирачна система', 1.0, 52),

  // 55: Parking brake
  wt('Диагностика ръчна спирачка', 0.8, 55),
  wt('Смяна жила ръчна спирачка', 1.8, 55),
  wt('Смяна клапан ръчна спирачка', 1.2, 55),

  // 56: Compressed-air brakes
  wt('Проверка утечки въздух (пневматика)', 1.0, 56),
  wt('Смяна въздушен сушител (патрон)', 0.8, 56),
  wt('Смяна въздушен сушител (модул)', 2.0, 56),
  wt('Смяна компресор въздух', 6.0, 56),
  wt('Смяна клапан 4-контурна защита', 1.8, 56),
  wt('Смяна клапан спирачки (реле)', 1.5, 56),
  wt('Смяна въздушен резервоар', 1.5, 56),
  wt('Смяна въздушен маркуч (една линия)', 1.0, 56),
  wt('Смяна спирачна камера (една)', 1.2, 56),
  wt('Смяна енергоакумулатор (една)', 1.5, 56),

  // 57: Trailer brake control and connections
  wt('Проверка/ремонт букса ремарке (ел.)', 1.0, 57),
  wt('Проверка/ремонт букса ремарке (пневм.)', 1.0, 57),
  wt('Смяна клапан управление ремарке', 1.5, 57),

  // 61: Front wheel suspension
  wt('Смяна тампон/втулка (една)', 2.0, 61),
  wt('Смяна шарнир (един)', 2.0, 61),
  wt('Смяна ресорен пакет (една страна)', 4.5, 61),
  wt('Смяна въздушна възглавница (една)', 2.5, 61),
  wt('Смяна стабилизираща щанга/щанги (линк)', 1.2, 61),

  // 64: Steering
  wt('Диагностика кормилна уредба', 1.0, 64),
  wt('Смяна накрайник (един)', 1.5, 64),
  wt('Смяна кормилна щанга', 2.0, 64),
  wt('Смяна кормилна рейка/кутия (ориент.)', 6.0, 64),
  wt('Смяна масло серво (ако има)', 1.0, 64),
  wt('Реглаж преден мост / сходимост', 1.5, 64),

  // 65: Rear wheel and trailing wheel suspension
  wt('Смяна въздушна възглавница заден мост (една)', 2.5, 65),
  wt('Смяна амортисьор заден (един)', 1.2, 65),
  wt('Смяна тампони окачване (комплект/ос)', 6.0, 65),

  // 71: Frame
  wt('Смяна тампон кабина (една позиция)', 1.5, 71),
  wt('Стягане/проверка крепеж рама (контрол)', 0.8, 71),

  // 76: Shock absorbers / anti-roll / leveling
  wt('Смяна амортисьор преден (един)', 1.2, 76),
  wt('Смяна амортисьори предни (2 бр.)', 2.0, 76),
  wt('Смяна амортисьори задни (2 бр.)', 2.0, 76),
  wt('Смяна клапан нивелиране', 1.2, 76),
  wt('Диагностика въздушно окачване', 1.2, 76),

  // 77: Wheels, tyres and hubs
  wt('Смяна гума (една)', 0.8, 77),
  wt('Смяна гуми (комплект 2 бр.)', 1.5, 77),
  wt('Смяна гуми (комплект 4 бр.)', 3.0, 77),
  wt('Балансиране гума (една)', 0.4, 77),
  wt('Балансиране гуми (2 бр.)', 0.8, 77),
  wt('Монтаж/демонтаж джанта (една)', 0.5, 77),
  wt('Смяна вентил гума (една)', 0.3, 77),
  wt('Смяна датчик налягане гума (TPMS) (един)', 0.5, 77),

  // 80: Body/cab general
  wt('Смяна ключалка врата', 1.2, 80),
  wt('Реглаж врата/панти', 1.0, 80),
  wt('Смяна огледало (ляво/дясно)', 1.0, 80),
  wt('Смяна стъкло врата (ориент.)', 2.5, 80),
  wt('Смяна моторче стъклоповдигач', 2.0, 80),
  wt('Смяна моторче чистачки', 2.0, 80),
  wt('Смяна помпа пръскалки', 0.8, 80),

  // 87: HVAC
  wt('Диагностика климатична система', 1.0, 87),
  wt('Пълнене климатик (евакуация + фреон)', 1.0, 87),
  wt('Смяна филтър купе', 0.5, 87),
  wt('Смяна компресор климатик', 4.5, 87),
  wt('Смяна кондензатор климатик', 3.0, 87),
  wt('Смяна изпарител (ориент.)', 7.0, 87),
  wt('Смяна вентилатор парно', 2.5, 87),
  wt('Смяна клапи/актуатори въздуховоди (ориент.)', 3.0, 87),

  // 91: Hydraulic/servo systems for several functions
  wt('Диагностика хидравлична система (обща)', 1.5, 91),
  wt('Смяна хидравлично масло (ако има)', 1.5, 91),
  wt('Смяна хидравличен маркуч (един)', 1.5, 91),
  wt('Смяна хидравлична помпа (ориент.)', 4.0, 91),

  // 93: Electrical equipment
  wt('Монтаж/демонтаж CB радио', 1.0, 93),
  wt('Монтаж/демонтаж GPS тракер', 1.5, 93),
  wt('Монтаж/демонтаж камера за обратно виждане', 2.0, 93),
  wt('Монтаж/демонтаж допълнителен контакт 12/24V', 0.8, 93),
  wt('Монтаж/демонтаж инвертор', 1.5, 93),

  // 94: Load handling / passenger lift
  wt('Проверка хидроборд (функционален тест)', 1.0, 94),
  wt('Диагностика хидроборд (ел.+хидр.)', 2.0, 94),
  wt('Смяна маркуч хидроборд', 2.0, 94),
  wt('Смяна хидравлична помпа хидроборд', 4.0, 94),
];

async function main() {
  const db = new sqlite3.Database(DB_PATH);
  db.configure('busyTimeout', 10_000);

  try {
    await run(db, 'PRAGMA foreign_keys = ON;');

    let inserted = 0;
    let skipped = 0;
    let updated = 0;

    // Ensure column exists (in case script is run before backend migration)
    try {
      await run(db, "ALTER TABLE worktimes ADD COLUMN vehicle_type TEXT DEFAULT 'truck'");
    } catch {
      // ignore
    }
    try {
      await run(db, "UPDATE worktimes SET vehicle_type = COALESCE(vehicle_type, 'truck')");
    } catch {
      // ignore
    }

    await run(db, 'BEGIN IMMEDIATE TRANSACTION');
    for (const item of SEED) {
      const title = String(item.title || '').trim();
      const component_type = String(item.component_type || '').trim() || '17';
      const vehicle_type = String(item.vehicle_type || 'truck').trim().toLowerCase() === 'trailer' ? 'trailer' : 'truck';
      const hours = safeHours(item.hours);
      if (!title) continue;

      const existing = await get(
        db,
        'SELECT id, hours FROM worktimes WHERE title = ? AND component_type = ? AND vehicle_type = ? LIMIT 1',
        [title, component_type, vehicle_type]
      );

      if (existing?.id) {
        // If hours differ, update (keep newest seed value)
        if (Number(existing.hours) !== Number(hours)) {
          await run(db, 'UPDATE worktimes SET hours = ? WHERE id = ?', [hours, existing.id]);
          updated += 1;
        } else {
          skipped += 1;
        }
        continue;
      }

      await run(
        db,
        'INSERT INTO worktimes (title, hours, component_type, vehicle_type) VALUES (?, ?, ?, ?)',
        [title, hours, component_type, vehicle_type]
      );
      inserted += 1;
    }
    await run(db, 'COMMIT');

    console.log('✅ Standard truck worktimes seeded');
    console.log({ dbPath: DB_PATH, inserted, updated, skipped, totalSeed: SEED.length });
  } catch (err) {
    try {
      await run(db, 'ROLLBACK');
    } catch {
      // ignore
    }
    console.error('❌ Seed failed:', err?.message || err);
    process.exitCode = 1;
  } finally {
    db.close();
  }
}

main();

